name: Docker

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: "00 23 * * *"

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  build:
    name: Pull
    runs-on: ubuntu-latest
    steps:
      - name: Before freeing up disk space
        run: |
          echo "Before freeing up disk space"
          echo "=============================================================================="
          df -hT
          echo "=============================================================================="

      # å¢åŠ å¯ç”¨ç£ç›˜ç©ºé—´
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: "true"
          remove-haskell: "true"
          # å¦‚æœç©ºé—´è¿˜æ˜¯ä¸å¤Ÿç”¨ï¼Œå¯ä»¥æŠŠä»¥ä¸‹å¼€å¯ï¼Œæ¸…ç†å‡ºæ›´å¤šç©ºé—´
          # remove-android: 'true'
          # remove-codeql: 'true'
          build-mount-path: "/var/lib/docker/"

      - name: Restart docker
        run: sudo service docker restart

      - name: Free up disk space complete
        run: |
          echo "Free up disk space complete"
          echo "=============================================================================="
          df -hT
          echo "=============================================================================="

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Docker Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install skopeo and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq

      - name: Build and push image Aliyun
        run: |
          docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY
          # æ•°æ®é¢„å¤„ç†,åˆ¤æ–­é•œåƒæ˜¯å¦é‡å
          declare -A duplicate_images
          declare -A temp_map
          while IFS= read -r line || [ -n "$line" ]; do
              # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
              [[ -z "$line" ]] && continue
              if echo "$line" | grep -q '^\s*#'; then
                  continue
              fi
              
              # è·å–é•œåƒçš„å®Œæ•´åç§°ï¼Œä¾‹å¦‚kasmweb/nginx:1.25.3ï¼ˆå‘½åç©ºé—´/é•œåƒå:ç‰ˆæœ¬å·ï¼‰
              image=$(echo "$line" | awk '{print $NF}')
              # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
              image="${image%%@*}"
              echo "image $image"
              # è·å–é•œåƒå:ç‰ˆæœ¬å·  ä¾‹å¦‚nginx:1.25.3
              image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
              echo "image_name_tag $image_name_tag"
              # è·å–å‘½åç©ºé—´ ä¾‹å¦‚kasmweb,  è¿™é‡Œæœ‰ç§ç‰¹æ®Šæƒ…å†µ docker.io/nginxï¼ŒæŠŠdocker.ioå½“æˆå‘½åç©ºé—´ï¼Œä¹ŸOK
              name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
              echo "name_space: $name_space"
              # è¿™é‡Œä¸è¦æ˜¯ç©ºå€¼å½±å“åˆ¤æ–­
              name_space="${name_space}_"
              # è·å–é•œåƒåä¾‹å¦‚nginx
              image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
              echo "image_name: $image_name"
              
              # å¦‚æœé•œåƒå­˜åœ¨äºæ•°ç»„ä¸­ï¼Œåˆ™æ·»åŠ temp_map
              if [[ -n "${temp_map[$image_name]}" ]]; then
                   # å¦‚æœtemp_mapå·²ç»å­˜åœ¨é•œåƒåï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€å‘½åç©ºé—´
                   if [[ "${temp_map[$image_name]}" != $name_space  ]]; then
                      echo "duplicate image name: $image_name"
                      duplicate_images[$image_name]="true"
                   fi
              else
                  # å­˜é•œåƒçš„å‘½åç©ºé—´
                  temp_map[$image_name]=$name_space
              fi       
          done < images.txt


          while IFS= read -r line || [ -n "$line" ]; do
              # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
              [[ -z "$line" ]] && continue
              if echo "$line" | grep -q '^\s*#'; then
                  continue
              fi

              echo "docker pull $line"
              docker pull $line
              platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
              echo "platform is $platform"
              # å¦‚æœå­˜åœ¨æ¶æ„ä¿¡æ¯ å°†æ¶æ„ä¿¡æ¯æ‹¼åˆ°é•œåƒåç§°å‰é¢
              if [ -z "$platform" ]; then
                  platform_prefix=""
              else
                  platform_prefix="${platform//\//_}_"
              fi
              echo "platform_prefix is $platform_prefix"
              # è·å–é•œåƒçš„å®Œæ•´åç§°ï¼Œä¾‹å¦‚kasmweb/nginx:1.25.3ï¼ˆå‘½åç©ºé—´/é•œåƒå:ç‰ˆæœ¬å·ï¼‰
              image=$(echo "$line" | awk '{print $NF}')

              # è·å– é•œåƒå:ç‰ˆæœ¬å·  ä¾‹å¦‚nginx:1.25.3
              image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
              # è·å–å‘½åç©ºé—´ ä¾‹å¦‚kasmweb  è¿™é‡Œæœ‰ç§ç‰¹æ®Šæƒ…å†µ docker.io/nginxï¼ŒæŠŠdocker.ioå½“æˆå‘½åç©ºé—´ï¼Œä¹ŸOK
              name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
              # è·å–é•œåƒåä¾‹  ä¾‹å¦‚nginx
              image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

              name_space_prefix=""
              # å¦‚æœé•œåƒåé‡å
              if [[ -n "${duplicate_images[$image_name]}" ]]; then
                 #å¦‚æœå‘½åç©ºé—´éç©ºï¼Œå°†å‘½åç©ºé—´åŠ åˆ°å‰ç¼€
                 if [[ -n "${name_space}" ]]; then
                    name_space_prefix="${name_space}_"
                 fi
              fi
              
              # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
              image_name_tag="${image_name_tag%%@*}"
              new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$platform_prefix$name_space_prefix$image_name_tag"
              echo "docker tag $image $new_image"
              docker tag $image $new_image
              
              # ä½¿ç”¨ skopeo æ£€æŸ¥é•œåƒæ˜¯å¦éœ€è¦æ¨é€
              echo "æ£€æŸ¥é•œåƒ: $new_image"
              
              # å°è¯•è·å–è¿œç¨‹é•œåƒä¿¡æ¯
              remote_info=$(skopeo inspect --creds $ALIYUN_REGISTRY_USER:$ALIYUN_REGISTRY_PASSWORD docker://$new_image 2>/dev/null)
              skip_push=false
              
              if [ -n "$remote_info" ]; then
                  # æå–è¿œç¨‹é•œåƒæ‘˜è¦
                  remote_digest=$(echo "$remote_info" | jq -r '.Digest')
                  echo "è¿œç¨‹é•œåƒæ‘˜è¦: $remote_digest"
                  
                  # è·å–æœ¬åœ°é•œåƒä¿¡æ¯
                  local_info=$(skopeo inspect docker-daemon:$new_image 2>/dev/null)
                  if [ -z "$local_info" ]; then
                      echo "æœ¬åœ°é•œåƒæ£€æŸ¥å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ push"
                  else
                      local_digest=$(echo "$local_info" | jq -r '.Digest')
                      echo "æœ¬åœ°é•œåƒæ‘˜è¦: $local_digest"
                      
                      # æ¯”è¾ƒæ‘˜è¦æ˜¯å¦ç›¸åŒ
                      if [ "$local_digest" == "$remote_digest" ]; then
                          echo "é•œåƒå†…å®¹ç›¸åŒï¼Œè·³è¿‡ docker push"
                          skip_push=true
                          push_time=$(date -u "+%Y-%m-%d %H:%M")
                          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
                            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
                            -d parse_mode=Markdown \
                            --data-urlencode text="ğŸ”„ *é•œåƒå†…å®¹ç›¸åŒï¼Œè·³è¿‡æ¨é€*  ğŸ•’ æ—¶é—´: ${push_time} UTC\`\`\`${new_image}\`\`\`"
                      fi
                  fi
              else
                  echo "è¿œç¨‹ä»“åº“æ²¡æœ‰è¯¥é•œåƒï¼Œå‡†å¤‡ push"
              fi
              
              # å¦‚æœä¸è·³è¿‡åˆ™æ‰§è¡Œæ¨é€
              if [ "$skip_push" = false ]; then
                  echo "docker push $new_image"
                  if docker push $new_image; then
                    push_time=$(date -u "+%Y-%m-%d %H:%M")
                    curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
                      -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
                      -d parse_mode=Markdown \
                      --data-urlencode text="ğŸ³ *é•œåƒæ¨é€æˆåŠŸï¼*  ğŸ•’ æ—¶é—´: ${push_time} UTC\`\`\`${new_image}\`\`\`"
                    
                  else
                    curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
                      -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
                      -d text="âŒ é•œåƒæ¨é€å¤±è´¥: $new_image"
                  fi
              fi
              
              echo "å¼€å§‹æ¸…ç†ç£ç›˜ç©ºé—´"
              echo "=============================================================================="
              df -hT
              echo "=============================================================================="
              docker rmi $image
              docker rmi $new_image
              echo "ç£ç›˜ç©ºé—´æ¸…ç†å®Œæ¯•"
              echo "=============================================================================="
              df -hT
              echo "=============================================================================="     
              
          done < images.txt
